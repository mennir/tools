<!DOCTYPE html>
<html>
<head>
	<title>GSC Sitemap</title>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="theme-color" content="#ffffff">
	<meta name="msapplication-TileColor" content="#ffffff">
	<link href="favicon.ico" rel="icon">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
	<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
	<div class="container">
		<div class="col-12 my-2" align="center"><a href=""><h1 class="h3">GSC Sitemap</h1></a></div>
		<div class="col-md-8 offset-md-2 my-2">
			<div class="card mb-4">
				<div class="card-header">
					<h1 class="h4 d-flex text-nowrap">Access Token: <span id="auth_status" class="text-success ms-2">Unauthorized</span><span id="expired_in" class="ms-auto fs-6 pt-2"></span></h1>
				</div>
				<div id="token_info" class="card-body">
					<button id="req_token" class="btn btn-sm btn-success">Request Token</button>
					<input id="access_token" class="form-control form-control-sm d-none" placeholder="Token.." value="">
				</div>
			</div>
			<div class="card">
				<div class="card-header">
					<h1 class="h4">Submit Sitemap</h1>
				</div>
				<div class="card-body">
					<div class="form-group mb-3">
						<button class="get_domains btn btn-sm btn-primary mb-2">Get Property List</button>
						<button class="get_sitemap_list btn btn-sm btn-primary mb-2">Get Sitemap List</button>
						<select id="arr_property" class="form-select form-select-sm mb-2" size="3" aria-label="Multiple select example">
							<option>Unavailable</option>
						</select>
					</div>
					<label class="mb-1">Sitemap index</label>
					<form id="fetch_sitemap_index">
						<div class="sitemap_index row mb-3">
							<div class="col-sm-6 pe-sm-0"><input class="property form-control form-control-sm" placeholder="Domain/property"></div>
							<div class="col-sm-4 pe-sm-0"><input class="path form-control form-control-sm" placeholder="Path"></div>
							<div class="col-sm-2"><button class="fetch btn btn-sm btn-primary w-100">FETCH</button></div>
						</div>
					</form>
					<div class="form-group mb-3">
					  <label for="arr_sitemap">Sitemap URL/Path</label>
					  <textarea class="arr_sitemap form-control form-control-sm" rows="4" id="arr_sitemap" placeholder="URL/path"></textarea>
					</div>
					<div>
						<button class="submit_sitemap btn btn-sm btn-primary">Submit</button>
						<button class="shuffle btn btn-sm btn-primary">Shuffle</button>
						<button class="fetch_all btn btn-sm btn-primary">Fetch All</button>
						<button class="clear btn btn-sm btn-secondary">Clear</button>
						<button class="delete_sitemap btn btn-sm btn-danger float-end">Delete</button>
					</div>
					<pre id="result_log" class="my-3"></pre>
				</div>
			</div>
		</div>
		<div class="mb-4 text-center">
			By EmbuhTeam
		</div>
	</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	var task_delay      = 500;
	var date 			= $.now();
	var pre_token 		= getParams()["access_token"];
	var oauth 			= sessionStorage.getItem('oauth');

	if(pre_token) {
		var expired 	= getParams()["expires_in"],
			expired 	= date + (expired * 1000);
		sessionStorage.setItem('oauth', true);
		sessionStorage.setItem('token_expired', expired);
		sessionStorage.setItem('access_token', pre_token);
	}
	else if(!oauth) {
		return google_auth();
	}

	var access_token 	= sessionStorage.getItem('access_token');
	var token_expired	= sessionStorage.getItem('token_expired');
	var tasks = [];
	var tasks_length = 0;
	var task_progress = 0;

	if(access_token) {
		var s_expired	= (token_expired - date) / 1000;
		var m_expired	= parseInt(s_expired / 60);

		if(m_expired < 5) {
			return google_auth();
		}

		$('#auth_status').text(`Authorized`);
		$('#access_token').val(access_token);
		$('#req_token, #access_token').toggleClass('d-none d-block');
		(function expiredCountDown() {
			if(token_expired < $.now()) {
				$('#req_token, #access_token').toggleClass('d-none d-block');
				$('#expired_in').text(`Token expired`);
				return null;
			}
			var expired = (token_expired - $.now());
			var mmss = new Date(expired).toISOString().slice(14, 19);
			$('#expired_in').text(`Expired after ${mmss}`);
			setTimeout(expiredCountDown, 1000);
		})();
	}

	var append_log = (text, overwrite) => $('#result_log')[overwrite ? 'text' : 'append'](text);
	var shuffle = (a) => {
		for (let i = a.length - 1; i > 0; i--) {
			const j = Math.floor(Math.random() * (i + 1));
			[a[i], a[j]] = [a[j], a[i]];
		}
		return a;
	};
	var get_domains = () => {
		// var a_token = $('#access_token').val();
		$.ajax({
	        url: 'https://www.googleapis.com/webmasters/v3/sites',
			type: 'GET',
			beforeSend: function (xhr) {
			    xhr.setRequestHeader('Authorization', `Bearer ${access_token}`);
			},
			success: function(data) {
				var arr 	= data.siteEntry;
				var arr_res = [];
				$('#arr_property').empty();
				if(!arr.length)
					return $('#arr_property').empty().append(`<option>No property detected.</option>`);
				$.each(arr, function (i, val) {
					var site = val.siteUrl;
			        if(val.permissionLevel == 'siteOwner' && !site.includes('sc-domain:'))
						$('#arr_property').append(`<option>${site}</option>`);
			    });
				// console.log($("#arr_property").val());
			}
	    });
	};
	var put_sitemap = (property, path) => {
		var sites    = encodeURIComponent(property);
		var url      = property + path;
		var sitemaps = encodeURIComponent(url);
		var target   = `https://content.googleapis.com/webmasters/v3/sites/${sites}/sitemaps/${sitemaps}`;
		task_progress++;
		append_log(`Submit sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nFetching ...`, true);
		$.post('tools.php', {act: 'sitemap', url}).done((response) => {
			append_log(`Submit sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nFetching done\nSubmitting sitemap ...`, true);
			$.ajax({
				url: target,
				type: 'PUT',
				beforeSend:  (xhr) => {
					xhr.setRequestHeader('Authorization', `Bearer ${access_token}`);
				},
			}).done((data, textStatus, jqXHR) => {
				switch(jqXHR.status) {
					case 204:
						append_log(`Submit sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nFetching done\nSubmitting sitemap done`, true);
						break;
					default:
						append_log(`Submit sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nFetching done\nSubmitting sitemap failed [${jqXHR.status}]`, true);
						// append_log(` ${jqXHR.status}`);
				}
			}).always(() => nextTask(put_sitemap));
		});
	};
	var delete_sitemap = (property, url) => {
		var sites    = encodeURIComponent(property);
		var sitemaps = encodeURIComponent(url);
		var target   = `https://content.googleapis.com/webmasters/v3/sites/${sites}/sitemaps/${sitemaps}`;
		task_progress++;
		append_log(`Delete sitemap ${task_progress} of ${tasks_length}\nURL: ${url}`, true);
		$.ajax({
			url: target,
			type: 'DELETE',
			beforeSend:  (xhr) => {
				xhr.setRequestHeader('Authorization', `Bearer ${access_token}`);
			},
		}).done((data, textStatus, jqXHR) => {
			switch(jqXHR.status) {
				case 204:
					append_log(`Delete sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nDeleting sitemap done`, true);
					break;
				default:
					append_log(`Delete sitemap ${task_progress} of ${tasks_length}\nURL: ${url}\nDeleting sitemap failed [${jqXHR.status}]`, true);
			}
		}).always(() => nextTask(delete_sitemap));
	};
	var get_sitemap_list = () => {
		var property = $('#arr_property').val();
		var sites    = encodeURIComponent(property);
		if(!property)
			return append_log("Get sitemap list: select property first", true);
		var target   = `https://www.googleapis.com/webmasters/v3/sites/${sites}/sitemaps`;
		append_log("Get sitemap list: fetching google API ...", true);
		$.ajax({
			url: target,
			type: 'GET',
			beforeSend:  (xhr) => {
				xhr.setRequestHeader('Authorization', `Bearer ${access_token}`);
			},
		}).done((data) => {
			// console.log(data.sitemap)
			if(!data.sitemap)
				return append_log("Get sitemap list: no sitemap detected", true);
			var sitemaps = [];
			data.sitemap.map(item => sitemaps.push(item.path));
			$('#arr_sitemap').val(sitemaps.join('\n')+'\n');
				return append_log(`Get sitemap list: ${data.sitemap.length} urls.`, true);
		});
	};
	var fetch_sitemap_index = (e) => {
		e.preventDefault();
		var property = $('.sitemap_index .property').val();
		var path = $('.sitemap_index .path').val()
		var url = property+path;
		if(!property)
			return append_log(`Fetch sitemap index: please select property`, true);
		if(!path)
			return append_log(`Fetch sitemap index: invalid path`, true);
		localStorage.setItem("sitemap_index_path", path);
		append_log(`Fetching sitemap index:\n${url}`, true);
		$.post('tools.php', {act: 'sitemap_index', url}).done((response) => {
			if(!response.data.length)
				return append_log(`\nDone: no url detected.`);
			$('#arr_sitemap').val(response.data.join('\n')+'\n');
			append_log(`\nDone: ${response.data.length} urls detected.`);
		});
	};
	var nextTask = (method) => {
		var task = tasks.shift();
		if(task) {
			setTimeout(() => method(...task), task_delay);
		} else {
			$('button.submit_sitemap').removeAttr('disabled');
			append_log(`${method.name}: ${tasks_length} URLs finished`, true);
		}
	};

	$('#req_token').on('click', google_auth);
	$('.get_domains').on('click', get_domains);
	$('.get_sitemap_list').on('click', get_sitemap_list);
	$('.submit_sitemap').on('click', function() {
		tasks = [];
		tasks_length = 0;
		task_progress = 0;
		var arr_sitemap = $("#arr_sitemap").val().replace(/\r\n/g,"\n").split("\n").filter(Boolean);
		var property = $('#arr_property').val();
		if(!property)
			return append_log('Select property first', true);
		append_log('Submitting sitemap ...', true);
		$('button.submit_sitemap').attr('disabled', 'disabled');
		for(var path of arr_sitemap) {
			// path = path.replace(property, '');
			path = path.substring(0, 4) == 'http' ? path.replace(property, '') : path;
			if(path.substring(0, 4) == 'http')
				return append_log('Submitting sitemap: Property and path do not match.', true);
			tasks.push([property, path]);
		}
		tasks_length = tasks.length;
		if(tasks_length) {
			nextTask(put_sitemap);
		} else {
			append_log('Nothing happen.', true);
			$('button.submit_sitemap').removeAttr('disabled');
		}
	});
	$('.delete_sitemap').on('click', function() {
		tasks = [];
		tasks_length = 0;
		task_progress = 0;
		var arr_sitemap = $("#arr_sitemap").val().replace(/\r\n/g,"\n").split("\n").filter(Boolean);
		var property = $('#arr_property').val();
		if(!property)
			return append_log('Select property first', true);
		append_log('Deleting sitemap ...', true);
		$('button.submit_sitemap').attr('disabled', 'disabled');
		for(const path of arr_sitemap) {
			tasks.push([property, path]);
		}
		tasks_length = tasks.length;
		if(tasks_length) {
			nextTask(delete_sitemap);
		} else {
			append_log('Nothing happen.', true);
			$('button.submit_sitemap').removeAttr('disabled');
		}
	});
	$('.clear').on('click', () => $('#arr_sitemap').val(''));
	$('.shuffle').on('click', function() {
		let source = $('#arr_sitemap').val().trim().split('\n').filter(Boolean);
		if(!source.length) return;
		let unique = [...new Set(source)];
		let randomized = shuffle(unique);
		$('#arr_sitemap').val(randomized.join('\n')+'\n');
		append_log(randomized.length+' lines was shuffled (from '+source.length+' lines).', true);
	});
	$('#arr_property').on('change', function() {
		$('.sitemap_index .property').val($(this).val());
	});
	$('#fetch_sitemap_index').on('submit', fetch_sitemap_index);
	$('.fetch_all').on('click', function() {
		var source = $('#arr_sitemap').val().split('\n').map(item => item.trim()).filter(Boolean);
		var progress = 0;
		var src_length = source.length;
		if(!source.length)
			return append_log(`Nothing to do`, true);
		(function fetch_one() {
			var url = source.shift();
			progress++;
			if(url) {
				append_log(`Fetching [${progress}/${src_length}] ${url} ...`, true);
				$.post('tools.php', {act: 'sitemap', url}).done(fetch_one);
			} else {
				append_log(`All done.`, true);
			}

		})();
	});

	$('.sitemap_index .path').val(localStorage.getItem("sitemap_index_path"));
	get_domains();
});
function getParams() {
	var vars = {};
	var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
		vars[key] = value;
	});
	return vars;
}
function google_auth() {
				var endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

				// Konfigurasi untuk beberapa domain
				var clients = {
					'buytostore.com': {
						client_id: '504358303018-a01sn11v15n28ge466nl75eipj30ma13.apps.googleusercontent.com',
						redirect_uri: 'https://buytostore.com/tools/sitemap.html'
					},
					'podomo.github.io': {
						client_id: '516002148536-c96a754vpuq2grt9vk2s5ces8ae2m7iu.apps.googleusercontent.com',
						redirect_uri: 'https://podomo.github.io/tools/sitemap.html'
					},
					'dugene.github.io': {
						client_id: '610494620907-ma4n1pi5d8b8c4t52pcfullq9uo4rlus.apps.googleusercontent.com',
						redirect_uri: 'https://dugene.github.io/tools/sitemap.html'
					},
					'mennir.github.io': {
						client_id: '271707406620-dp5t8djth0v3dotfmcuiiq6l8fhtcqh4.apps.googleusercontent.com',
						redirect_uri: 'https://mennir.github.io/tools/sitemap.html'
					}
				};

				// Ambil domain saat ini dari window.location
				var currentDomain = window.location.hostname;

				// Pilih client_id dan redirect_uri berdasarkan domain
				var selectedClient = clients[currentDomain];

				if (!selectedClient) {
					console.error('Domain tidak ditemukan dalam konfigurasi OAuth');
					return;
				}

				var scope = encodeURIComponent('https://www.googleapis.com/auth/webmasters');
				var redirect = encodeURIComponent(selectedClient.redirect_uri);
				var client_id = selectedClient.client_id;

				// Redirect ke halaman autentikasi Google OAuth dengan client_id dan redirect_uri yang sesuai
				window.location = `https://accounts.google.com/o/oauth2/v2/auth?include_granted_scopes=true&response_type=token&state=state_parameter_passthrough_value&redirect_uri=${redirect}&client_id=${client_id}&scope=${scope}`;
			}
</script>
</html>
